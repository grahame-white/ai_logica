#!/bin/bash

# script/check-e2e-status: Check the status of end-to-end testing setup
#                         without attempting to run tests or install browsers

set -e

cd "$(dirname "$0")/.."

echo "ğŸ” AI Logica - End-to-End Testing Status Check"
echo "============================================="
echo ""

# Check if solution builds
echo "ğŸ“‹ Checking project build status..."
if dotnet build --configuration Release > /dev/null 2>&1; then
    echo "âœ… Project builds successfully"
else
    echo "âŒ Project build failed"
    echo "ğŸ’¡ Run 'dotnet build' to see build errors"
    exit 1
fi

# Check if Playwright package is available
echo "ğŸ“¦ Checking Playwright package availability..."
if dotnet test --filter "PlaywrightPackage_ShouldBeAvailable" --verbosity quiet > /dev/null 2>&1; then
    echo "âœ… Playwright package is correctly installed"
else
    echo "âŒ Playwright package issues detected"
    echo "ğŸ’¡ Check package references in AiLogica.Tests.csproj"
fi

# Check if infrastructure tests pass
echo "ğŸ—ï¸ Checking E2E infrastructure..."
if dotnet test --filter "EndToEndInfrastructureTests" --verbosity quiet > /dev/null 2>&1; then
    echo "âœ… E2E infrastructure tests pass"
else
    echo "âŒ E2E infrastructure tests fail"
    echo "ğŸ’¡ Run './script/test --infrastructure' for details"
fi

# Check for Playwright script
PLAYWRIGHT_SCRIPT="./AiLogica.Tests/bin/Release/net8.0/playwright.ps1"
if [ -f "$PLAYWRIGHT_SCRIPT" ]; then
    echo "âœ… Playwright installation script found"
else
    echo "âš ï¸  Playwright installation script not found"
    echo "ğŸ’¡ Run 'dotnet build --configuration Release' first"
fi

# Check for PowerShell (optional)
echo "ğŸ”§ Checking optional tools..."
if command -v pwsh >/dev/null 2>&1; then
    echo "âœ… PowerShell available (preferred for browser installation)"
else
    echo "âš ï¸  PowerShell not available (alternative browser installation will be used)"
fi

# Check for unit tests status
echo "ğŸ§ª Checking unit test status..."
if dotnet test --filter "Category!=EndToEnd" --verbosity quiet > /dev/null 2>&1; then
    echo "âœ… Unit tests pass"
else
    echo "âŒ Unit tests fail"
    echo "ğŸ’¡ Fix unit tests before running E2E tests"
fi

echo ""
echo "ğŸ“Š Status Summary:"
echo "=================="

# Determine overall readiness
BUILD_OK=true
INFRA_OK=true
UNIT_OK=true

if ! dotnet build --configuration Release > /dev/null 2>&1; then
    BUILD_OK=false
fi

if ! dotnet test --filter "EndToEndInfrastructureTests" --verbosity quiet > /dev/null 2>&1; then
    INFRA_OK=false
fi

if ! dotnet test --filter "Category!=EndToEnd" --verbosity quiet > /dev/null 2>&1; then
    UNIT_OK=false
fi

if [ "$BUILD_OK" = true ] && [ "$INFRA_OK" = true ] && [ "$UNIT_OK" = true ]; then
    echo "ğŸ‰ E2E testing infrastructure is ready!"
    echo ""
    echo "ğŸ“‹ Next steps:"
    echo "   â€¢ Run infrastructure tests: ./script/test --infrastructure"
    echo "   â€¢ Run unit tests: ./script/test"
    echo "   â€¢ Attempt E2E setup: ./script/run-e2e-tests.sh"
    echo "   â€¢ Run full test suite: ./script/test --all"
else
    echo "âš ï¸  E2E testing infrastructure needs attention"
    echo ""
    echo "ğŸ”§ Required fixes:"
    if [ "$BUILD_OK" = false ]; then
        echo "   â€¢ Fix build errors: dotnet build"
    fi
    if [ "$UNIT_OK" = false ]; then
        echo "   â€¢ Fix unit tests: ./script/test"
    fi
    if [ "$INFRA_OK" = false ]; then
        echo "   â€¢ Fix infrastructure: ./script/test --infrastructure"
    fi
fi

echo ""
echo "ğŸ’¡ For detailed troubleshooting, see: E2E_TESTING_GUIDE.md"